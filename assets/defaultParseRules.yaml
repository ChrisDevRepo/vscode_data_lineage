# ─── DACPAC Lineage Parser Rules (Single Source of Truth) ────────────────────
# Regex rules for extracting SQL dependencies from stored procedure bodies.
# Covers all MS SQL family: SQL Server, Azure Synapse, Microsoft Fabric DWH.
# View and UDF dependencies come from dacpac XML — no regex parsing needed.
#
# This file is the ONLY definition of the built-in parse rules.
# - Bundled in the VSIX and loaded at runtime by the extension host.
# - Copied to user workspace when running "Create Parse Rules" command.
# - No TypeScript fallback — this YAML is the source of truth.
#
# Rules run in priority order (lowest first). Disable rules with enabled: false.
#
#   name:        Unique identifier
#   enabled:     true/false to toggle
#   priority:    Execution order (lower = earlier)
#   category:    preprocessing | source | target | exec
#   pattern:     JavaScript regex (capture group 1 = object reference)
#   flags:       Regex flags (gi = global, case-insensitive)
#   replacement: (preprocessing only) replacement string
#   description: What this rule extracts
# ─────────────────────────────────────────────────────────────────────────────

rules:
  # ── Preprocessing ──────────────────────────────────────────────────────────
  # Single-pass: brackets, strings, and comments matched together, leftmost wins.
  # Built-in function replacement (brackets → keep, strings → neutralize, comments → remove).
  - name: clean_sql
    enabled: true
    priority: 1
    category: preprocessing
    pattern: "\\[[^\\]]+\\]|'(?:''|[^'])*'|--[^\\r\\n]*|\\/\\*[\\s\\S]*?\\*\\/"
    flags: g
    description: "Single-pass bracket/string/comment handling (built-in)"

  # ── Source extraction ──────────────────────────────────────────────────────
  - name: extract_sources_ansi
    enabled: true
    priority: 5
    category: source
    pattern: "\\b(?:FROM|(?:(?:INNER|LEFT|RIGHT|FULL|CROSS|OUTER)\\s+(?:OUTER\\s+)?)?JOIN)\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: FROM/JOIN sources (handles 2- and 3-part names)

  - name: extract_sources_tsql_apply
    enabled: true
    priority: 7
    category: source
    pattern: "\\b(?:CROSS|OUTER)\\s+APPLY\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: CROSS/OUTER APPLY sources

  - name: extract_merge_using
    enabled: true
    priority: 9
    category: source
    pattern: "\\bMERGE\\b[\\s\\S]*?\\bUSING\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: MERGE ... USING source table

  - name: extract_udf_calls
    enabled: true
    priority: 10
    category: source
    pattern: "((?:(?:\\[[^\\]]+\\]|\\w+)\\.)+(?:\\[[^\\]]+\\]|\\w+))\\s*\\("
    flags: gi
    description: "Inline scalar UDF calls (schema.func() — requires 2+ part name)"

  # ── Target extraction ──────────────────────────────────────────────────────
  - name: extract_targets_dml
    enabled: true
    priority: 6
    category: target
    pattern: "\\b(?:INSERT\\s+(?:INTO\\s+)?|UPDATE\\s+|MERGE\\s+(?:INTO\\s+)?)((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: INSERT/UPDATE/MERGE targets (DELETE/TRUNCATE excluded — not lineage)

  - name: extract_ctas
    enabled: true
    priority: 13
    category: target
    pattern: "\\bCREATE\\s+TABLE\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))\\s+AS\\s+SELECT"
    flags: gi
    description: CREATE TABLE AS SELECT target (Synapse/Fabric)

  - name: extract_select_into
    enabled: true
    priority: 14
    category: target
    pattern: "\\bINTO\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))\\s+FROM"
    flags: gi
    description: SELECT INTO target

  - name: extract_copy_into
    enabled: true
    priority: 15
    category: target
    pattern: "\\bCOPY\\s+INTO\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "COPY INTO target (Fabric/Synapse)"

  - name: extract_bulk_insert
    enabled: true
    priority: 16
    category: target
    pattern: "\\bBULK\\s+INSERT\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "BULK INSERT target (SQL Server)"

  - name: extract_update_alias_target
    enabled: true
    priority: 17
    category: target
    pattern: "\\bUPDATE\\s+(?!\\[?\\w+\\]?\\s*\\.)\\[?\\w+\\]?\\s+SET\\b[\\s\\S]{0,3000}?\\bFROM\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "UPDATE alias SET ... FROM schema.table — when UPDATE uses an alias (no dot), captures the actual write target from the FROM clause. Bidirectional edge expected: the table also appears as a source via extract_sources_ansi."

  # ── Exec calls ─────────────────────────────────────────────────────────────
  - name: extract_sp_calls
    enabled: true
    priority: 8
    category: exec
    pattern: "\\bEXEC(?:UTE)?\\s+(?!AS\\s+)(?:@\\w+\\s*=\\s*)?((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "EXEC/EXECUTE procedure calls (including @var = proc pattern; excludes EXECUTE AS context clause)"
