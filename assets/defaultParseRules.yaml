# ─── DACPAC Lineage Parser Rules (Single Source of Truth) ────────────────────
# Regex rules for extracting SQL dependencies from stored procedure bodies.
# Covers all MS SQL family: SQL Server, Azure Synapse, Microsoft Fabric DWH.
# View and UDF dependencies come from dacpac XML — no regex parsing needed.
#
# This file is the ONLY definition of the built-in parse rules.
# - Bundled in the VSIX and loaded at runtime by the extension host.
# - Copied to user workspace when running "Create Parse Rules" command.
# - No TypeScript fallback — this YAML is the source of truth.
#
# Rules run in priority order (lowest first). Disable rules with enabled: false.
#
#   name:        Unique identifier
#   enabled:     true/false to toggle
#   priority:    Execution order (lower = earlier)
#   category:    preprocessing | source | target | exec
#   pattern:     JavaScript regex (capture group 1 = object reference)
#   flags:       Regex flags (gi = global, case-insensitive)
#   replacement: (preprocessing only) replacement string
#   description: What this rule extracts
#
# ── What the SQL looks like when your rules receive it ───────────────────────
#
# Before any YAML rule runs, the TypeScript cleansing pipeline transforms the SQL:
#
#  ORIGINAL SQL:
#    /* filter /* nested */ comment */ SELECT col -- line comment
#    FROM [dbo].[Orders]  /* comment */
#    JOIN "staging"."Log" ON ...      -- double-quoted identifiers
#    WHERE x = 'don''t skip this'
#    EXEC [dbo].[sp_Proc]
#
#  AFTER CLEANSING (what your regex sees):
#    SELECT col
#    FROM [dbo].[Orders]
#    JOIN [staging].[Log] ON ...      ← "double-quotes" converted to [brackets]
#    WHERE x = ''                     ← string content neutralized
#    EXEC [dbo].[sp_Proc]
#
# Key guarantees for rule authors:
#  • Block comments removed (including nested /* /* */ */ — TypeScript counter-scan)
#  • Line comments (--) removed
#  • String literals replaced with '' (content cannot produce false matches)
#  • [bracket identifiers] preserved exactly as written
#  • "double-quoted" identifiers converted to [bracket] notation
#  • Capture group 1 is normalized before catalog lookup:
#      - [schema].[object] and "schema"."object" → [schema].[object]
#      - 3-part db.schema.object → schema.object (database prefix stripped)
#      - 4-part server.db.schema.object → rejected (never in local catalog)
#      - @variables and #temp tables → rejected (never in catalog)
#      - Unqualified names (no dot) → rejected (schema.object required)
# ─────────────────────────────────────────────────────────────────────────────

rules:
  # ── Preprocessing ──────────────────────────────────────────────────────────
  # NOTE: The clean_sql rule below DOCUMENTS the built-in cleansing behavior.
  # It is NOT executed as a configurable rule — the actual implementation is
  # hardcoded in sqlBodyParser.ts (removeBlockComments + Phase 1 leftmost-match).
  # Modifying this rule's pattern has NO EFFECT. To change preprocessing,
  # edit sqlBodyParser.ts directly.
  - name: clean_sql
    enabled: true
    priority: 1
    category: preprocessing
    pattern: "\\[[^\\]]+\\]|\"[^\"]*\"|'(?:''|[^'])*'|--[^\\r\\n]*"
    flags: g
    description: >
      Documents built-in SQL cleansing (TypeScript, not configurable via YAML).
      Pass 0: counter-scan removes nested block comments /* /* */ */.
      Pass 1: leftmost-match — [brackets] preserved, "double-quotes" → [brackets],
      'strings' neutralized to '', -- comments removed. Block comments already gone.
      Result: clean SQL with only bracket-quoted identifiers, suitable for regex rules.

  # ── Source extraction ──────────────────────────────────────────────────────
  - name: extract_sources_ansi
    enabled: true
    priority: 5
    category: source
    pattern: "\\b(?:FROM|(?:(?:INNER|LEFT|RIGHT|FULL|CROSS|OUTER)\\s+(?:OUTER\\s+)?)?JOIN)\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: FROM/JOIN sources (handles 2- and 3-part names)

  - name: extract_sources_tsql_apply
    enabled: true
    priority: 7
    category: source
    pattern: "\\b(?:CROSS|OUTER)\\s+APPLY\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: CROSS/OUTER APPLY sources

  - name: extract_merge_using
    enabled: true
    priority: 9
    category: source
    pattern: "\\bMERGE\\b[\\s\\S]*?\\bUSING\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: MERGE ... USING source table

  - name: extract_udf_calls
    enabled: true
    priority: 10
    category: source
    pattern: "((?:(?:\\[[^\\]]+\\]|\\w+)\\.)+(?:\\[[^\\]]+\\]|\\w+))\\s*\\("
    flags: gi
    description: "Inline scalar UDF calls (schema.func() — requires 2+ part name)"

  # ── Target extraction ──────────────────────────────────────────────────────
  - name: extract_targets_dml
    enabled: true
    priority: 6
    category: target
    pattern: "\\b(?:INSERT\\s+(?:INTO\\s+)?|UPDATE\\s+|MERGE\\s+(?:INTO\\s+)?)((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: INSERT/UPDATE/MERGE targets (DELETE/TRUNCATE excluded — not lineage)

  - name: extract_ctas
    enabled: true
    priority: 13
    category: target
    pattern: "\\bCREATE\\s+TABLE\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))\\s+AS\\s+SELECT"
    flags: gi
    description: CREATE TABLE AS SELECT target (Synapse/Fabric)

  - name: extract_select_into
    enabled: true
    priority: 14
    category: target
    pattern: "\\bINTO\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))\\s+FROM"
    flags: gi
    description: SELECT INTO target

  - name: extract_copy_into
    enabled: true
    priority: 15
    category: target
    pattern: "\\bCOPY\\s+INTO\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "COPY INTO target (Fabric/Synapse)"

  - name: extract_bulk_insert
    enabled: true
    priority: 16
    category: target
    pattern: "\\bBULK\\s+INSERT\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "BULK INSERT target (SQL Server)"

  - name: extract_update_alias_target
    enabled: true
    priority: 17
    category: target
    pattern: "\\bUPDATE\\s+(?!\\[?\\w+\\]?\\s*\\.)\\[?\\w+\\]?\\s+SET\\b[\\s\\S]{0,3000}?\\bFROM\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "UPDATE alias SET ... FROM schema.table — when UPDATE uses an alias (no dot), captures the actual write target from the FROM clause. Bidirectional edge expected: the table also appears as a source via extract_sources_ansi."

  # ── Exec calls ─────────────────────────────────────────────────────────────
  - name: extract_sp_calls
    enabled: true
    priority: 8
    category: exec
    pattern: "\\bEXEC(?:UTE)?\\s+(?!AS\\s+)(?:@\\w+\\s*=\\s*)?((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "EXEC/EXECUTE procedure calls (including @var = proc pattern; excludes EXECUTE AS context clause)"
