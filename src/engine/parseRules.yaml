# ─── DACPAC Lineage Parser Rules ─────────────────────────────────────────────
# Edit these regex patterns to customize how SQL body dependencies are extracted.
# Rules run in priority order (lowest first) against stored procedure bodies.
# Tables, Views, and UDF dependencies are read from dacpac XML — these rules
# only supplement SP body parsing where XML BodyDependencies may be incomplete.
#
# Each rule has:
#   name:        Unique identifier
#   enabled:     true/false to toggle
#   priority:    Execution order (lower = earlier)
#   category:    preprocessing | source | target | exec
#   pattern:     JavaScript regex (capture group 1 = object reference)
#   flags:       Regex flags (g = global, i = case-insensitive)
#   replacement: (preprocessing only) replacement string
#   description: What this rule extracts
#
# FALLBACK: If this file is missing, empty, or invalid YAML, the extension
# falls back to built-in DEFAULT_RULES in sqlBodyParser.ts (same 9 rules)
# and shows a warning message to the user.
#
# IMPORTANT: This file and DEFAULT_RULES must stay in sync.
# When this file loads successfully, it REPLACES all defaults — any rule
# not listed here will be lost. See docs/PARSE_RULES.md for details.
# ─────────────────────────────────────────────────────────────────────────────

rules:
  # ── Preprocessing (priority 1) ───────────────────────────────────────────
  # Single-pass combined regex: brackets, strings, and comments matched
  # together, leftmost match wins. This prevents -- inside strings or
  # bracket-quoted names being treated as comments. Built-in function
  # replacement in parseSqlBody() handles the logic (brackets → keep,
  # strings → neutralize, comments → remove). No static replacement.

  - name: clean_sql                                 # also in DEFAULT_RULES
    enabled: true
    priority: 1
    category: preprocessing
    pattern: "\\[[^\\]]+\\]|'(?:''|[^'])*'|--[^\\r\\n]*|\\/\\*[\\s\\S]*?\\*\\/"
    flags: g
    description: "Single-pass bracket/string/comment handling (built-in)"

  # ── Source extraction (priority 5-9) ──────────────────────────────────────
  # Tables the SP reads from. Edge direction: table → SP

  - name: extract_sources_ansi                      # also in DEFAULT_RULES
    enabled: true
    priority: 5
    category: source
    pattern: "\\b(?:FROM|(?:(?:INNER|LEFT|RIGHT|FULL|CROSS|OUTER)\\s+(?:OUTER\\s+)?)?JOIN)\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: Extract source table references from FROM/JOIN clauses

  - name: extract_sources_tsql_apply                # also in DEFAULT_RULES
    enabled: true
    priority: 7
    category: source
    pattern: "\\b(?:CROSS|OUTER)\\s+APPLY\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: Extract source references from T-SQL APPLY operators

  - name: extract_merge_using                       # also in DEFAULT_RULES
    enabled: true
    priority: 9
    category: source
    pattern: "\\bMERGE\\b[\\s\\S]*?\\bUSING\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: Extract source table from MERGE ... USING

  - name: extract_udf_calls                         # also in DEFAULT_RULES
    enabled: true
    priority: 10
    category: source
    pattern: "((?:(?:\\[[^\\]]+\\]|\\w+)\\.)+(?:\\[[^\\]]+\\]|\\w+))\\s*\\("
    flags: gi
    description: "Inline scalar UDF calls (schema.func() — requires 2+ part name)"

  # ── Target extraction (priority 6-14) ─────────────────────────────────────
  # Tables the SP writes to. Edge direction: SP → table

  - name: extract_targets_dml                       # also in DEFAULT_RULES
    enabled: true
    priority: 6
    category: target
    pattern: "\\b(?:INSERT\\s+(?:INTO\\s+)?|UPDATE\\s+|MERGE\\s+(?:INTO\\s+)?)((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: Extract target tables from INSERT/UPDATE/MERGE (DELETE/TRUNCATE excluded — not lineage)

  - name: extract_select_into                       # also in DEFAULT_RULES
    enabled: true
    priority: 14
    category: target
    pattern: "\\bINTO\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))\\s+FROM"
    flags: gi
    description: Extract T-SQL SELECT INTO target tables

  - name: extract_ctas                              # also in DEFAULT_RULES
    enabled: true
    priority: 13
    category: target
    pattern: "\\bCREATE\\s+TABLE\\s+((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))\\s+AS\\s+SELECT"
    flags: gi
    description: Extract CREATE TABLE AS SELECT target

  # ── Exec calls (priority 8) ───────────────────────────────────────────────
  # Procedure calls. Edge direction: SP → called_SP

  - name: extract_sp_calls                          # also in DEFAULT_RULES
    enabled: true
    priority: 8
    category: exec
    pattern: "\\bEXEC(?:UTE)?\\s+(?:@\\w+\\s*=\\s*)?((?:(?:\\[[^\\]]+\\]|\\w+)\\.)*(?:\\[[^\\]]+\\]|\\w+))"
    flags: gi
    description: "EXEC/EXECUTE procedure calls (including @var = proc pattern)"

# ─── Skip Patterns ──────────────────────────────────────────────────────────
# Object names matching these prefixes are ignored (system objects, temp tables)
skip_prefixes:
  - "#"
  - "@"
  - "sys."
  - "sp_"
  - "xp_"
  - "fn_"
  - "information_schema."
  - "master."
  - "msdb."
  - "tempdb."
  - "model."

# Keywords that look like identifiers but aren't
skip_keywords:
  - set
  - declare
  - print
  - return
  - begin
  - end
  - if
  - else
  - while
  - break
  - continue
  - goto
  - try
  - catch
  - throw
  - raiserror
  - waitfor
  - as
  - "is"
  - "null"
  - not
  - and
  - or
  - select
  - where
  - group
  - order
  - having
  - top
  - distinct
  - table
  - index
  - view
  - procedure
  - function
  - trigger
  - values
  - output
  - with
  - nolock
  - "on"
