-- generated sp 54: tier=medium flags=[nocaps,noformatting]
-- expect  sources:[stg].[orderstage],[fin].[transaction]  targets:[stg].[invoicestage],[dbo].[customer]  exec:[dbo].[usp_updatecustomer],[etl].[usp_loadproducts],[audit].[usp_logaccess]

create procedure [etl].[usp_genmedium_054] @batchid    int = 0, @processdate datetime = null as begin set nocount on; if @processdate is null set @processdate = getdate(); declare @rowcount int = 0; declare @starttime datetime = getutcdate(); insert into [stg].[invoicestage] ([sourceid], [sourcename], [loadedat]) select s.[id], s.[name], getutcdate() from   [stg].[orderstage] as s where  s.[isdeleted] = 0; set @rowcount = @rowcount + @@rowcount; insert into dbo.customer ([sourceid], [refid], [amount], [loadedat]) select a.[id]          as sourceid, b.[id]          as refid, isnull(a.[amount], 0) as amount, getutcdate()    as loadedat from   [stg].[orderstage] as a join   [fin].[transaction] as c on c.[id] = a.[id] where  a.[status] = n'pending'; set @rowcount = @rowcount + @@rowcount; update t set    t.[status]      = s.[status], t.[updateddate] = getutcdate() from   [stg].[invoicestage] as t join   fin.transaction as s on s.[id] = t.[sourceid] where  t.[status] = n'pending'; set @rowcount = @rowcount + @@rowcount; exec [dbo].[usp_updatecustomer] @processdate = getdate(), @batchid = @batchid; exec etl.usp_loadproducts @processdate = getdate(), @batchid = @batchid; exec audit.usp_logaccess @processdate = getdate(), @batchid = @batchid; select @rowcount = count(*) from stg.orderstage where [isdeleted] = 0; select @rowcount = count(*) from fin.transaction where [isdeleted] = 0; return @rowcount; end go